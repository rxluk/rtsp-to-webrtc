<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>4x RTSP para WebRTC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-width: 100%;
            height: calc(100vh - 150px);
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #000;
        }
        .rtsp-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .rtsp-input input {
            flex-grow: 1;
            margin-right: 10px;
            padding: 8px;
        }
        .status {
            margin-top: 5px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="rtsp-input">
        <input type="text" id="rtspUrl1" placeholder="RTSP URL 1">
        <button onclick="connect(1)">Conectar 1</button>
    </div>
    <div class="rtsp-input">
        <input type="text" id="rtspUrl2" placeholder="RTSP URL 2">
        <button onclick="connect(2)">Conectar 2</button>
    </div>
    <div class="rtsp-input">
        <input type="text" id="rtspUrl3" placeholder="RTSP URL 3">
        <button onclick="connect(3)">Conectar 3</button>
    </div>
    <div class="rtsp-input">
        <input type="text" id="rtspUrl4" placeholder="RTSP URL 4">
        <button onclick="connect(4)">Conectar 4</button>
    </div>

    <div class="container">
        <div class="video-container">
            <div id="status1" class="status">Desconectado</div>
            <video id="remoteVideo1" autoplay playsinline controls muted></video>
        </div>
        <div class="video-container">
            <div id="status2" class="status">Desconectado</div>
            <video id="remoteVideo2" autoplay playsinline controls muted></video>
        </div>
        <div class="video-container">
            <div id="status3" class="status">Desconectado</div>
            <video id="remoteVideo3" autoplay playsinline controls muted></video>
        </div>
        <div class="video-container">
            <div id="status4" class="status">Desconectado</div>
            <video id="remoteVideo4" autoplay playsinline controls muted></video>
        </div>
    </div>
    
    <script>
        const connections = [null, null, null, null];
        const websockets = [null, null, null, null];

        function updateStatus(streamId, message) {
            document.getElementById(`status${streamId}`).textContent = message;
        }
        
        async function connect(streamId) {
            const rtspUrl = document.getElementById(`rtspUrl${streamId}`).value;
            if (!rtspUrl) {
                alert(`Por favor, insira uma URL RTSP válida para o stream ${streamId}`);
                return;
            }
            
            updateStatus(streamId, "Conectando ao servidor...");
            
            // Cria WebSocket connection
            const ws = new WebSocket(`ws://localhost:8080`);
            websockets[streamId - 1] = ws;
            
            ws.onopen = function() {
                updateStatus(streamId, "Conectado ao servidor. Enviando URL RTSP...");
                ws.send(rtspUrl);
            };
            
            ws.onmessage = async function(evt) {
                const data = JSON.parse(evt.data);
                if (data.type === "offer") {
                    await handleOffer(streamId, data);
                }
            };
            
            ws.onclose = function() {
                updateStatus(streamId, "Desconectado do servidor");
                if (connections[streamId - 1]) {
                    connections[streamId - 1].close();
                    connections[streamId - 1] = null;
                }
            };
            
            ws.onerror = function(err) {
                updateStatus(streamId, "Erro na conexão WebSocket");
                console.error(`WebSocket Error (Stream ${streamId}):`, err);
            };
        }
        
        async function handleOffer(streamId, offer) {
            updateStatus(streamId, "Recebida oferta SDP. Configurando WebRTC...");
            
            try {
                // Cria peer connection
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                });
                connections[streamId - 1] = pc;
                
                // Seleciona o vídeo correto
                const remoteVideo = document.getElementById(`remoteVideo${streamId}`);
                
                // Adiciona handlers de eventos
                pc.ontrack = function(event) {
                    updateStatus(streamId, "Stream recebido! Reproduzindo vídeo...");
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                };
                
                pc.onicecandidate = function(event) {
                    if (event.candidate === null) {
                        // ICE gathering completo, envia descrição completa
                        const sdp = pc.localDescription;
                        websockets[streamId - 1].send(JSON.stringify(sdp));
                    }
                };
                
                pc.onconnectionstatechange = function() {
                    updateStatus(streamId, "Estado WebRTC: " + pc.connectionState);
                };
                
                // Define oferta remota
                await pc.setRemoteDescription(offer);
                
                // Cria resposta
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                updateStatus(streamId, "Enviando resposta SDP...");
                
            } catch (error) {
                updateStatus(streamId, "Erro ao processar oferta: " + error);
                console.error(`Error handling offer (Stream ${streamId}):`, error);
            }
        }
    </script>
</body>
</html>